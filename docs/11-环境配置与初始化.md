# 十一、环境配置与初始化

> 记录项目开发环境的配置信息和初始化步骤。

---

## 1. 数据库配置

### 1.1 连接信息

| 配置项 | 值 |
|-------|---|
| 数据库类型 | MySQL 8.0 |
| 主机 | localhost |
| 端口 | 3306 |
| 数据库名 | health_db |
| 用户名 | root |
| 密码 | 1234 |
| 字符集 | utf8mb4 |
| 排序规则 | utf8mb4_unicode_ci |

### 1.2 连接字符串

```
# Python SQLAlchemy (异步)
mysql+aiomysql://root:1234@localhost:3306/health_db

# Python SQLAlchemy (同步)
mysql+pymysql://root:1234@localhost:3306/health_db

# Node.js
mysql://root:1234@localhost:3306/health_db
```

### 1.3 已创建的数据表（38张）

| 模块 | 表名 | 说明 |
|-----|------|-----|
| **用户模块** | users | 用户表 |
| | user_health_profiles | 用户健康档案表 |
| | user_addresses | 用户收货地址表 |
| **健康筛查** | health_screenings | 健康筛查记录表 |
| | health_reminders | 健康提醒表 |
| **运动模块** | sport_records | 运动记录表 |
| | sport_goals | 运动目标表 |
| | courses | 运动课程表 |
| | user_course_collects | 用户收藏课程表 |
| **膳食模块** | food_records | 膳食记录表 |
| | food_library | 食物库 |
| **商城模块** | product_categories | 商品分类表 |
| | products | 商品表 |
| | product_reviews | 商品评价表 |
| | carts | 购物车表 |
| | coupons | 优惠券表 |
| | user_coupons | 用户优惠券表 |
| | orders | 订单表 |
| | order_items | 订单商品表 |
| **社区模块** | posts | 动态/帖子表 |
| | post_comments | 动态评论表 |
| | post_likes | 动态点赞表 |
| | topics | 话题表 |
| | user_follows | 用户关注表 |
| **私信模块** | conversations | 会话表 |
| | messages | 私信消息表 |
| **积分任务** | coin_records | 积分记录表 |
| | checkin_records | 打卡记录表 |
| | daily_tasks | 每日任务配置表 |
| | user_task_records | 用户任务记录表 |
| **会员模块** | member_orders | 会员订单表 |
| **AI模块** | ai_chat_records | AI对话记录表 |
| **系统管理** | admins | 管理员表 |
| | admin_logs | 管理员操作日志表 |
| | notifications | 通知表 |
| | banners | 轮播图表 |
| | system_configs | 系统配置表 |
| | files | 文件管理表 |

### 1.4 数据库初始化命令

如需重新初始化数据库，执行以下步骤：

```sql
-- 1. 创建数据库
CREATE DATABASE IF NOT EXISTS health_db 
DEFAULT CHARACTER SET utf8mb4 
COLLATE utf8mb4_unicode_ci;

-- 2. 切换到数据库
USE health_db;

-- 3. 执行建表脚本
SOURCE docs/数据库设计/init-all.sql;
```

或通过命令行：

```bash
mysql -u root -p1234 -e "CREATE DATABASE IF NOT EXISTS health_db DEFAULT CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci;"
mysql -u root -p1234 health_db < docs/数据库设计/init-all.sql
```

---

## 2. 开发环境要求

### 2.1 必需软件

| 软件 | 最低版本 | 用途 |
|-----|---------|-----|
| Node.js | 18.x | 前端构建 |
| Python | 3.10+ | 后端运行 |
| MySQL | 8.0 | 数据库 |
| HBuilderX | 最新版 | uni-app 开发 |
| VS Code | 最新版 | 后端/Web 管理端开发 |
| 微信开发者工具 | 最新版 | 小程序调试 |

### 2.2 可选软件

| 软件 | 版本 | 用途 |
|-----|------|-----|
| Redis | 6.x+ | 缓存（后期加入） |
| Docker | 最新版 | 部署 |

---

## 3. 项目初始化步骤

### 3.1 小程序前端（uni-app + Vue 3）

```bash
# 方式一：使用 degit 创建
npx degit dcloudio/uni-preset-vue#vite-ts miniprogram-frontend
cd miniprogram-frontend
npm install
npm install wot-design-uni pinia

# 方式二：使用 HBuilderX
# 文件 → 新建 → 项目 → uni-app → Vue3
```

### 3.2 后端（Python + FastAPI）

```bash
mkdir backend
cd backend

# 创建虚拟环境
python -m venv venv

# 激活虚拟环境 (Windows)
.\venv\Scripts\activate

# 激活虚拟环境 (Mac/Linux)
source venv/bin/activate

# 安装依赖
pip install fastapi uvicorn sqlalchemy aiomysql redis pydantic python-jose dashscope python-multipart alembic
```

### 3.3 Web 管理端（Vue 3 + Element Plus）

```bash
npm create vite@latest admin-web -- --template vue-ts
cd admin-web
npm install
npm install element-plus @element-plus/icons-vue pinia vue-router axios
```

---

## 4. 配置文件模板

### 4.1 后端 `.env` 文件

```env
# ==================== 数据库配置 ====================
DATABASE_URL=mysql+aiomysql://root:1234@localhost:3306/health_db

# ==================== Redis 配置（可选）====================
REDIS_URL=redis://localhost:6379

# ==================== JWT 配置 ====================
JWT_SECRET_KEY=your-random-secret-key-change-this-in-production
JWT_ALGORITHM=HS256
JWT_EXPIRE_MINUTES=10080

# ==================== 微信小程序配置 ====================
WECHAT_APPID=                    # 待填入
WECHAT_SECRET=                   # 待填入

# ==================== 阿里云百炼平台 ====================
DASHSCOPE_API_KEY=               # 待填入

# ==================== 暂缓配置（后续补充）====================
WECHAT_MCH_ID=                   # 微信支付商户号
ALIPAY_APP_ID=                   # 支付宝应用ID  
TENCENT_MAP_KEY=                 # 腾讯地图服务Key
```

### 4.2 前端环境变量

在 uni-app 项目根目录创建：

**`.env.development`**
```env
VITE_API_BASE_URL=http://localhost:8000/api/v1
VITE_UPLOAD_URL=http://localhost:8000/api/v1/upload
```

**`.env.production`**
```env
VITE_API_BASE_URL=https://your-domain.com/api/v1
VITE_UPLOAD_URL=https://your-domain.com/api/v1/upload
```

---

## 5. 启动服务

### 5.1 启动 MySQL 服务

```bash
# Windows
net start mysql80

# 或通过服务管理器
# Win + R → services.msc → 找到 MySQL80 → 启动
```

### 5.2 启动后端服务

```bash
cd backend
.\venv\Scripts\activate
uvicorn app.main:app --reload --host 0.0.0.0 --port 8000
```

### 5.3 启动前端开发服务

```bash
cd miniprogram-frontend
npm run dev:mp-weixin
```

### 5.4 启动 Web 管理端

```bash
cd admin-web
npm run dev
```

---

## 6. 初始化记录

| 日期 | 操作 | 结果 |
|-----|------|-----|
| 2024-11-27 | 创建数据库 health_db | 成功 |
| 2024-11-27 | 初始化 38 张数据表 | 成功 |

---

## 7. 常见问题

### Q1: MySQL 无法连接 (ERROR 2003)

**原因**：MySQL 服务未启动

**解决**：
```bash
net start mysql80
```

### Q2: MySQL 密码错误 (ERROR 1045)

**原因**：密码不正确

**解决**：确认密码为 `1234`，或重置密码

### Q3: 表已存在错误

**原因**：重复执行建表脚本

**解决**：
```sql
DROP DATABASE health_db;
CREATE DATABASE health_db DEFAULT CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci;
-- 然后重新执行建表脚本
```

