# 十、部署方案

## 10.1 图片存储方案

### 图片分类

| 图片类型 | 存储位置 | 数据库存储 |
|---------|---------|-----------|
| **UI静态资源**（图标、Logo、引导图） | uni-app `static/` 目录，打包进小程序 | 不需要存 |
| **系统通用图片**（商品默认图、分类图标） | 服务器 `static/` 目录 | 不需要存 |
| **用户上传图片**（头像、饮食、运动、动态） | 服务器 `uploads/` 目录 | 只存相对路径 |

### 服务器存储目录

```
/var/www/health-app/
├── backend/                    # Python 后端代码
├── static/                     # 系统静态资源
│   ├── icons/
│   ├── images/
│   └── default/                # 默认图片
└── uploads/                    # 用户上传文件
    ├── avatar/                 # 用户头像
    │   └── {user_id}.jpg
    ├── food/                   # 饮食照片
    │   └── {year}/{month}/{day}/{filename}.jpg
    ├── sport/                  # 运动照片
    │   └── {year}/{month}/{day}/{filename}.jpg
    └── post/                   # 社区动态图片
        └── {year}/{month}/{day}/{filename}.jpg
```

### 文件命名规则

```
{用户ID}_{时间戳}_{随机串}.{扩展名}

示例：
- avatar/u10001.jpg
- food/2025/11/26/u10001_1732608000_a3f2b1.jpg
- post/2025/11/26/u10001_1732608000_img1.jpg
```

---

## 10.2 Nginx 配置

```nginx
server {
    listen 80;
    server_name your-domain.com;

    # API 转发到 FastAPI
    location /api/ {
        proxy_pass http://127.0.0.1:8000;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
    }

    # 系统静态资源
    location /static/ {
        alias /var/www/health-app/static/;
        expires 30d;
    }

    # 用户上传文件
    location /uploads/ {
        alias /var/www/health-app/uploads/;
        expires 7d;
    }
}
```

---

## 10.3 Docker 部署

### docker-compose.yml

```yaml
version: '3.8'

services:
  # FastAPI 后端
  backend:
    build: ./backend
    ports:
      - "8000:8000"
    environment:
      - DATABASE_URL=mysql+aiomysql://user:pass@mysql:3306/health_db
      - REDIS_URL=redis://redis:6379
    depends_on:
      - mysql
      - redis
    volumes:
      - ./uploads:/app/uploads
      - ./static:/app/static

  # MySQL 数据库
  mysql:
    image: mysql:8.0
    environment:
      MYSQL_ROOT_PASSWORD: root_password
      MYSQL_DATABASE: health_db
      MYSQL_USER: user
      MYSQL_PASSWORD: pass
    ports:
      - "3306:3306"
    volumes:
      - mysql_data:/var/lib/mysql

  # Redis 缓存
  redis:
    image: redis:7-alpine
    ports:
      - "6379:6379"

  # Nginx 反向代理
  nginx:
    image: nginx:alpine
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./nginx.conf:/etc/nginx/conf.d/default.conf
      - ./uploads:/var/www/health-app/uploads
      - ./static:/var/www/health-app/static
    depends_on:
      - backend

volumes:
  mysql_data:
```

### 启动命令

```bash
# 启动所有服务
docker-compose up -d

# 查看日志
docker-compose logs -f backend

# 停止服务
docker-compose down
```


