# 八、技术栈与架构

## 8.1 技术栈（已确定）

| 层级 | 技术选型 | 说明 |
|-----|---------|-----|
| **小程序前端** | uni-app + Vue 3 | 面向C端用户 |
| **UI组件库** | Wot Design Uni | 主要组件库，能用则用 |
| **Web管理端** | Vue 3 + Element Plus | 面向平台管理员 |
| **后端框架** | Python + FastAPI | 异步高性能，AI生态好 |
| **ORM** | SQLAlchemy 2.0 + Alembic | 数据库操作 + 迁移管理 |
| **数据库** | MySQL 8.0 | 主数据存储 |
| **缓存** | Redis | 会话管理、排行榜、接口限流 |
| **AI服务** | 阿里云百炼平台 | AI健康助手（API Key待配置） |
| **支付** | 微信支付 / 支付宝 | 商城支付（暂缓实现） |
| **地图** | 腾讯地图SDK | 运动轨迹记录（GPS后端暂缓） |
| **图片存储** | 服务器本地 + Nginx | 详见部署方案 |
| **部署** | Docker + Nginx | 反向代理 + 静态托管 |

> 暂缓实现的功能详见：[00-开发约束与说明.md](./00-开发约束与说明.md)

---

## 8.2 小程序组件库

### 主要组件库：Wot Design Uni

官网：https://wot-design-uni.pages.dev/

**优先使用此组件库**，简洁方便，能用则用。

```bash
# 安装
npm install wot-design-uni
```

```javascript
// main.js 中配置
import { createSSRApp } from 'vue'
import App from './App.vue'

export function createApp() {
  const app = createSSRApp(App)
  return { app }
}
```

```json
// pages.json 中配置 easycom
{
  "easycom": {
    "autoscan": true,
    "custom": {
      "^wd-(.*)": "wot-design-uni/components/wd-$1/wd-$1.vue"
    }
  }
}
```

### 常用组件速查

| 组件 | 用途 |
|-----|------|
| `wd-button` | 按钮 |
| `wd-cell` | 单元格/列表项 |
| `wd-card` | 卡片 |
| `wd-input` | 输入框 |
| `wd-picker` | 选择器 |
| `wd-tabs` | 标签页 |
| `wd-popup` | 弹出层 |
| `wd-toast` | 轻提示 |
| `wd-loading` | 加载 |
| `wd-swiper` | 轮播图 |
| `wd-grid` | 宫格 |
| `wd-navbar` | 导航栏 |
| `wd-tabbar` | 标签栏 |
| `wd-skeleton` | 骨架屏 |
| `wd-form` | 表单 |
| `wd-upload` | 上传 |
| `wd-rate` | 评分 |
| `wd-fab` | 悬浮按钮 |

### 组件使用示例

```vue
<template>
  <!-- 单元格/列表项 - 支持页面跳转 -->
  <wd-cell title="帮助与反馈" is-link to="/pages/help/index" />
  
  <!-- 带点击反馈 -->
  <wd-cell title="设置" value="内容" clickable @click="handleClick" />
  
  <!-- 表单必填项 -->
  <wd-cell title="评分" required>
    <wd-rate v-model="rate" @change="handleRateChange" />
  </wd-cell>
</template>

<script setup lang="ts">
import { ref } from 'vue'
import { useToast } from '@/uni_modules/wot-design-uni'

const toast = useToast()
const rate = ref(0)

function handleClick() {
  toast.show('点击了')
}

function handleRateChange({ value }: { value: number }) {
  console.log('评分:', value)
}
</script>
```

### 备选/补充组件库

如后期需要更多组件，可考虑以下补充：

| 组件库 | 特点 | 官网 |
|-------|------|-----|
| **uv-ui** | 兼容 Vue 3，组件丰富 | https://www.uvui.cn/ |
| **uView Plus** | uView 的 Vue 3 版本 | https://uiadmin.net/uview-plus/ |
| **TuniaoUI** | 设计感强，适合年轻用户 | https://vue3.tuniaokj.com/ |
| **uni-ui** | 官方组件库，兼容性最好 | https://uniapp.dcloud.net.cn/component/uniui/uni-ui.html |

### 组件库使用原则

1. **优先使用 Wot Design Uni**，保持一致性
2. Wot Design Uni 没有的组件，可用 uni-ui 补充
3. 特殊需求再考虑其他组件库
4. 避免同时引入过多组件库，增加包体积

---

## 8.2 后端项目结构

```
health-management-backend/
├── app/
│   ├── __init__.py
│   ├── main.py                 # FastAPI 入口
│   ├── config.py               # 配置文件
│   ├── database.py             # 数据库连接
│   │
│   ├── models/                 # 数据库模型 (SQLAlchemy)
│   │   ├── __init__.py
│   │   ├── user.py             # 用户模型
│   │   ├── health_record.py    # 健康筛查记录
│   │   ├── sport_record.py     # 运动记录
│   │   ├── food_record.py      # 饮食记录
│   │   ├── product.py          # 商品
│   │   ├── order.py            # 订单
│   │   ├── post.py             # 社区动态
│   │   └── points.py           # 积分记录
│   │
│   ├── schemas/                # Pydantic 数据验证
│   │   └── ...
│   │
│   ├── api/                    # API 路由
│   │   └── v1/
│   │       ├── auth.py         # 登录注册
│   │       ├── user.py         # 用户管理
│   │       ├── health.py       # 健康筛查
│   │       ├── sport.py        # 运动记录
│   │       ├── food.py         # 饮食记录
│   │       ├── shop.py         # 商城
│   │       ├── order.py        # 订单
│   │       ├── community.py    # 社区
│   │       ├── points.py       # 积分
│   │       └── upload.py       # 文件上传
│   │
│   ├── services/               # 业务逻辑
│   │   ├── ai_service.py       # 大模型调用
│   │   ├── health_service.py   # 健康分析
│   │   └── payment_service.py  # 支付处理
│   │
│   └── utils/                  # 工具函数
│       ├── security.py         # JWT、加密
│       └── file.py             # 文件处理
│
├── uploads/                    # 用户上传文件（不进Git）
├── static/                     # 系统静态资源
├── alembic/                    # 数据库迁移
├── tests/                      # 测试
├── requirements.txt
├── Dockerfile
└── docker-compose.yml
```

---

## 8.3 后端代码示例 (FastAPI)

### 路由模块化

```python
# app/routers/user.py
from fastapi import APIRouter, Depends
from sqlalchemy.ext.asyncio import AsyncSession
from app.database import get_db
from app.schemas.user import UserResponse, UserUpdate

router = APIRouter(prefix="/user", tags=["用户"])

@router.get("/profile", response_model=UserResponse)
async def get_profile(
    current_user = Depends(get_current_user),
    db: AsyncSession = Depends(get_db)
):
    """获取当前用户信息"""
    return current_user

@router.put("/profile", response_model=UserResponse)
async def update_profile(
    data: UserUpdate,
    current_user = Depends(get_current_user),
    db: AsyncSession = Depends(get_db)
):
    """更新用户信息"""
    # 更新逻辑
    pass
```

### 主应用入口

```python
# app/main.py
from fastapi import FastAPI
from fastapi.middleware.cors import CORSMiddleware
from app.routers import user, health, sport, food, shop, order, community, points

app = FastAPI(
    title="健康管理API",
    version="1.0.0"
)

# CORS
app.add_middleware(
    CORSMiddleware,
    allow_origins=["*"],
    allow_methods=["*"],
    allow_headers=["*"],
)

# 注册路由
app.include_router(user.router, prefix="/api/v1")
app.include_router(health.router, prefix="/api/v1")
app.include_router(sport.router, prefix="/api/v1")
app.include_router(food.router, prefix="/api/v1")
app.include_router(shop.router, prefix="/api/v1")
app.include_router(order.router, prefix="/api/v1")
app.include_router(community.router, prefix="/api/v1")
app.include_router(points.router, prefix="/api/v1")

@app.get("/")
async def root():
    return {"message": "健康管理API服务"}
```

### 暂缓实现的接口模板

```python
# app/routers/order.py
@router.post("/{order_id}/pay")
async def create_payment(order_id: int, pay_type: str):
    """
    发起支付
    
    TODO: 暂缓实现
    原因: 需要微信商户号、API密钥
    当前: 直接返回模拟支付成功
    """
    return {
        "code": 200,
        "message": "模拟支付成功",
        "data": {
            "order_id": order_id,
            "status": "paid"
        }
    }
```

---

## 8.4 前端项目结构 (uni-app + Vue 3)

```
health-management-app/
├── src/
│   ├── pages/                  # 页面
│   │   ├── index/              # 首页（健康管理）
│   │   ├── screening/          # 健康筛查
│   │   ├── sport/              # 运动记录
│   │   ├── food/               # 饮食记录
│   │   ├── community/          # 社区
│   │   ├── shop/               # 商城
│   │   ├── cart/               # 购物车
│   │   ├── order/              # 订单
│   │   └── user/               # 个人中心
│   │
│   ├── components/             # 公共组件（自定义）
│   ├── composables/            # 组合式函数
│   ├── api/                    # 接口封装
│   ├── store/                  # 状态管理 (Pinia)
│   │   ├── index.ts
│   │   ├── user.ts             # 用户状态
│   │   ├── cart.ts             # 购物车状态
│   │   └── app.ts              # 应用全局状态
│   ├── utils/                  # 工具函数
│   │   ├── request.ts          # 请求封装
│   │   ├── storage.ts          # 本地存储
│   │   └── common.ts           # 通用工具
│   │
│   ├── App.vue
│   ├── main.ts
│   ├── manifest.json
│   ├── pages.json
│   └── uni.scss                # 全局样式 + CSS变量
│
├── static/                     # 静态资源（打包进小程序）
│   ├── tabbar/                 # 底部导航图标（待填充）
│   ├── icons/                  # 功能图标（待填充）
│   ├── images/                 # 引导图（待填充）
│   └── placeholder/            # 占位图
│       └── default.png
│
├── package.json
├── tsconfig.json
├── vite.config.ts
└── index.html
```

### package.json 核心依赖

```json
{
  "dependencies": {
    "vue": "^3.4.0",
    "pinia": "^2.1.0",
    "wot-design-uni": "^1.2.0"
  },
  "devDependencies": {
    "@dcloudio/uni-app": "^3.0.0",
    "@dcloudio/vite-plugin-uni": "^3.0.0",
    "typescript": "^5.0.0",
    "vite": "^5.0.0",
    "sass": "^1.69.0"
  }
}
```

### uni-app Vue 3 生命周期

```vue
<script setup lang="ts">
import { ref, onMounted } from 'vue'
import { onLoad, onShow, onReady, onHide } from '@dcloudio/uni-app'

// 通过 props 接收 URL 参数
// 如: uni.navigateTo({ url: '/pages/detail/index?id=10' })
const props = defineProps<{
  id?: string
}>()

// 页面加载时（可获取页面参数）
onLoad((options) => {
  console.log('页面加载，参数:', options)
  // options.id 或 props.id 都可获取参数
})

// 页面显示时
onShow(() => {
  console.log('页面显示')
})

// 页面初次渲染完成
onReady(() => {
  console.log('页面准备完成')
})

// 页面隐藏时
onHide(() => {
  console.log('页面隐藏')
})

// Vue 生命周期同样可用
onMounted(() => {
  console.log('组件挂载完成')
})
</script>
```

### Pinia 状态管理

**定义 Store（Setup 风格，推荐）**：

```typescript
// stores/user.ts
import { defineStore } from 'pinia'
import { ref, computed } from 'vue'

export const useUserStore = defineStore('user', () => {
  // state
  const userInfo = ref<UserInfo | null>(null)
  const token = ref('')
  
  // getters
  const isLoggedIn = computed(() => !!token.value)
  const nickname = computed(() => userInfo.value?.nickname || '游客')
  
  // actions
  function setToken(newToken: string) {
    token.value = newToken
    uni.setStorageSync('token', newToken)
  }
  
  function setUserInfo(info: UserInfo) {
    userInfo.value = info
  }
  
  function logout() {
    token.value = ''
    userInfo.value = null
    uni.removeStorageSync('token')
  }
  
  return { 
    userInfo, 
    token, 
    isLoggedIn, 
    nickname,
    setToken, 
    setUserInfo, 
    logout 
  }
})
```

**在组件中使用 Store**：

```vue
<script setup lang="ts">
import { computed } from 'vue'
import { useUserStore } from '@/stores/user'

const userStore = useUserStore()

// 正确：直接使用 store 属性或 computed
const isLoggedIn = computed(() => userStore.isLoggedIn)

// 错误：解构会丢失响应性
// const { isLoggedIn } = userStore  // ❌

function handleLogout() {
  userStore.logout()
  uni.reLaunch({ url: '/pages/index/index' })
}
</script>

<template>
  <view>{{ userStore.nickname }}</view>
  <wd-button v-if="isLoggedIn" @click="handleLogout">退出登录</wd-button>
</template>
```

---

## 8.4 Web管理端项目结构 (Vue 3)

```
health-management-admin/
├── src/
│   ├── api/                    # 接口封装
│   ├── assets/                 # 静态资源
│   ├── components/             # 公共组件
│   ├── layouts/                # 布局组件
│   ├── router/                 # 路由配置
│   ├── store/                  # 状态管理 (Pinia)
│   ├── utils/                  # 工具函数
│   ├── views/                  # 页面
│   │   ├── dashboard/          # 数据看板
│   │   ├── user/               # 用户管理
│   │   ├── content/            # 内容审核
│   │   ├── product/            # 商品管理
│   │   ├── order/              # 订单管理
│   │   ├── statistics/         # 数据统计
│   │   └── system/             # 系统设置
│   ├── App.vue
│   └── main.ts
├── public/
├── package.json
├── vite.config.ts
└── tsconfig.json
```


