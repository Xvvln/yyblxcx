# 十三、后端开发文档

> 本文档记录 Python FastAPI 后端的实现详情。

---

## 1. 项目结构

```
backend/
├── app/
│   ├── __init__.py
│   ├── main.py                 # FastAPI 应用入口
│   ├── config.py               # 配置管理
│   ├── database.py             # 数据库连接
│   │
│   ├── models/                 # SQLAlchemy 模型
│   │   ├── __init__.py
│   │   ├── user.py             # 用户、健康档案、地址
│   │   ├── health.py           # 健康筛查、提醒
│   │   ├── sport.py            # 运动记录、目标
│   │   ├── food.py             # 饮食记录、食物库
│   │   ├── course.py           # 课程、收藏
│   │   ├── shop.py             # 商品、分类、评价
│   │   ├── cart.py             # 购物车
│   │   ├── order.py            # 订单、订单项
│   │   ├── coupon.py           # 优惠券
│   │   ├── community.py        # 动态、评论、点赞、话题、关注
│   │   ├── message.py          # 会话、私信
│   │   ├── points.py           # 积分、签到、任务
│   │   ├── member.py           # 会员订单
│   │   └── system.py           # 管理员、日志、通知、轮播图、配置、AI记录
│   │
│   ├── schemas/                # Pydantic 数据验证
│   │   ├── __init__.py
│   │   ├── common.py           # 通用响应模型
│   │   ├── auth.py             # 认证相关
│   │   └── user.py             # 用户相关
│   │
│   ├── api/                    # API 路由
│   │   ├── __init__.py
│   │   ├── v1/                 # 小程序端 API (v1)
│   │   │   ├── __init__.py
│   │   │   ├── auth.py         # 登录注册
│   │   │   ├── user.py         # 用户管理
│   │   │   ├── health.py       # 健康筛查
│   │   │   ├── sport.py        # 运动记录
│   │   │   ├── sport_goal.py   # 运动目标
│   │   │   ├── food.py         # 饮食记录
│   │   │   ├── food_library.py # 食物库
│   │   │   ├── course.py       # 课程
│   │   │   ├── shop.py         # 商城
│   │   │   ├── cart.py         # 购物车
│   │   │   ├── order.py        # 订单
│   │   │   ├── coupon.py       # 优惠券
│   │   │   ├── community.py    # 社区
│   │   │   ├── message.py      # 私信
│   │   │   ├── points.py       # 积分
│   │   │   ├── task.py         # 任务
│   │   │   ├── checkin.py      # 签到
│   │   │   ├── member.py       # 会员
│   │   │   ├── reminder.py     # 提醒
│   │   │   ├── address.py      # 地址
│   │   │   ├── doctor.py       # 远程医疗（Mock）
│   │   │   ├── ai.py           # AI助手
│   │   │   ├── notification.py # 通知
│   │   │   ├── banner.py       # 轮播图
│   │   │   ├── stats.py        # 个人统计
│   │   │   ├── upload.py       # 文件上传
│   │   │   └── settings.py     # 用户设置与反馈
│   │   │
│   │   └── admin/              # 管理后台 API
│   │       ├── __init__.py
│   │       ├── auth.py         # 管理员认证
│   │       ├── user.py         # 用户管理
│   │       ├── audit.py        # 内容审核
│   │       ├── product.py      # 商品管理
│   │       ├── order.py        # 订单管理
│   │       ├── stats.py        # 数据统计
│   │       ├── setting.py      # 系统设置
│   │       └── feedback.py     # 反馈管理
│   │
│   ├── services/               # 业务逻辑层
│   │   ├── __init__.py
│   │   └── ai_service.py       # AI 服务（阿里云百炼）
│   │
│   └── utils/                  # 工具函数
│       ├── __init__.py
│       ├── security.py         # JWT、密码加密
│       ├── response.py         # 统一响应格式
│       └── helpers.py          # 辅助函数
│
├── uploads/                    # 用户上传文件（不进Git）
├── requirements.txt            # Python 依赖
├── run.py                      # 启动脚本
├── README.md                   # 后端说明
└── .env.example                # 环境变量示例
```

---

## 2. 已实现的 API 接口

### 2.1 小程序端接口 (`/api/v1/`)

#### 认证模块
| 方法 | 路径 | 说明 | 状态 |
|------|-----|------|------|
| POST | `/auth/login` | 微信登录 | ✅ |
| POST | `/auth/register` | 完善用户信息 | ✅ |

#### 用户模块
| 方法 | 路径 | 说明 | 状态 |
|------|-----|------|------|
| GET | `/user/profile` | 获取个人信息 | ✅ |
| PUT | `/user/profile` | 更新个人信息 | ✅ |
| POST | `/user/avatar` | 上传头像 | ✅ |
| GET | `/user/health-profile` | 获取健康档案 | ✅ |
| PUT | `/user/health-profile` | 更新健康档案 | ✅ |

#### 健康筛查模块
| 方法 | 路径 | 说明 | 状态 |
|------|-----|------|------|
| POST | `/health/screening` | 提交筛查数据 | ✅ |
| GET | `/health/records` | 筛查记录列表 | ✅ |
| GET | `/health/report/{id}` | 获取报告详情 | ✅ |

#### 运动模块
| 方法 | 路径 | 说明 | 状态 |
|------|-----|------|------|
| POST | `/sport/record` | 提交运动记录 | ✅ |
| GET | `/sport/records` | 运动记录列表 | ✅ |
| POST | `/sport/checkin` | 运动打卡 | ✅ |
| GET | `/sport-goal` | 运动目标列表 | ✅ |
| POST | `/sport-goal` | 创建运动目标 | ✅ |
| PUT | `/sport-goal/{id}` | 更新运动目标 | ✅ |
| DELETE | `/sport-goal/{id}` | 删除运动目标 | ✅ |
| GET | `/sport-goal/stats` | 目标统计 | ✅ |

#### 饮食模块
| 方法 | 路径 | 说明 | 状态 |
|------|-----|------|------|
| POST | `/food/record` | 提交饮食记录 | ✅ |
| GET | `/food/records` | 饮食记录列表 | ✅ |
| POST | `/food/checkin` | 饮食打卡 | ✅ |
| GET | `/food-library/search` | 搜索食物库 | ✅ |
| GET | `/food-library/categories` | 食物分类 | ✅ |
| GET | `/food-library/{id}` | 食物详情 | ✅ |

#### 课程模块
| 方法 | 路径 | 说明 | 状态 |
|------|-----|------|------|
| GET | `/course/list` | 课程列表 | ✅ |
| GET | `/course/{id}` | 课程详情 | ✅ |
| POST | `/course/{id}/collect` | 收藏课程 | ✅ |
| DELETE | `/course/{id}/collect` | 取消收藏 | ✅ |
| GET | `/course/my-collects` | 我的收藏 | ✅ |

#### 商城模块
| 方法 | 路径 | 说明 | 状态 |
|------|-----|------|------|
| GET | `/shop/products` | 商品列表 | ✅ |
| GET | `/shop/product/{id}` | 商品详情 | ✅ |
| GET | `/shop/categories` | 商品分类 | ✅ |
| GET | `/shop/product/{id}/reviews` | 商品评价列表 | ✅ |

#### 购物车模块
| 方法 | 路径 | 说明 | 状态 |
|------|-----|------|------|
| GET | `/cart` | 购物车列表 | ✅ |
| POST | `/cart` | 添加购物车 | ✅ |
| PUT | `/cart/{id}` | 修改数量 | ✅ |
| DELETE | `/cart/{id}` | 删除商品 | ✅ |

#### 订单模块
| 方法 | 路径 | 说明 | 状态 |
|------|-----|------|------|
| POST | `/order` | 创建订单 | ✅ |
| GET | `/order/list` | 订单列表 | ✅ |
| GET | `/order/{id}` | 订单详情 | ✅ |
| POST | `/order/{id}/pay` | 发起支付 | ✅ (Mock) |
| POST | `/order/{id}/cancel` | 取消订单 | ✅ |
| POST | `/order/{id}/confirm` | 确认收货 | ✅ |
| POST | `/order/{id}/review` | 提交评价 | ✅ |

#### 优惠券模块
| 方法 | 路径 | 说明 | 状态 |
|------|-----|------|------|
| GET | `/coupon/available` | 可领取优惠券 | ✅ |
| POST | `/coupon/{id}/receive` | 领取优惠券 | ✅ |
| GET | `/coupon/my-coupons` | 我的优惠券 | ✅ |

#### 社区模块
| 方法 | 路径 | 说明 | 状态 |
|------|-----|------|------|
| GET | `/community/posts` | 动态列表 | ✅ |
| POST | `/community/post` | 发布动态 | ✅ |
| DELETE | `/community/post/{id}` | 删除动态 | ✅ |
| POST | `/community/post/{id}/like` | 点赞 | ✅ |
| DELETE | `/community/post/{id}/like` | 取消点赞 | ✅ |
| POST | `/community/post/{id}/comment` | 评论 | ✅ |
| GET | `/community/post/{id}/comments` | 评论列表 | ✅ |
| GET | `/community/following` | 关注列表 | ✅ |
| GET | `/community/followers` | 粉丝列表 | ✅ |
| POST | `/community/follow/{user_id}` | 关注用户 | ✅ |
| DELETE | `/community/follow/{user_id}` | 取消关注 | ✅ |
| GET | `/community/topics` | 话题列表 | ✅ |
| GET | `/community/topic/{id}` | 话题详情 | ✅ |
| GET | `/community/ranking` | 排行榜 | ✅ |

#### 私聊模块
| 方法 | 路径 | 说明 | 状态 |
|------|-----|------|------|
| GET | `/message/conversations` | 会话列表 | ✅ |
| GET | `/message/history/{user_id}` | 聊天记录 | ✅ |
| POST | `/message/send` | 发送消息 | ✅ |
| POST | `/message/read/{conversation_id}` | 标记已读 | ✅ |

#### 积分模块
| 方法 | 路径 | 说明 | 状态 |
|------|-----|------|------|
| GET | `/points/balance` | 积分余额 | ✅ |
| GET | `/points/records` | 积分记录 | ✅ |
| GET | `/points/gifts` | 可兑换礼品 | ✅ |
| POST | `/points/exchange` | 兑换礼品 | ✅ |

#### 任务模块
| 方法 | 路径 | 说明 | 状态 |
|------|-----|------|------|
| GET | `/task/daily` | 今日任务列表 | ✅ |
| GET | `/task/progress` | 任务进度 | ✅ |
| POST | `/task/{id}/claim` | 领取任务奖励 | ✅ |

#### 签到模块
| 方法 | 路径 | 说明 | 状态 |
|------|-----|------|------|
| POST | `/checkin` | 每日签到 | ✅ |
| GET | `/checkin/status` | 签到状态 | ✅ |
| GET | `/checkin/calendar` | 签到日历 | ✅ |
| GET | `/checkin/stats` | 签到统计 | ✅ |

#### 会员模块
| 方法 | 路径 | 说明 | 状态 |
|------|-----|------|------|
| GET | `/member/info` | 会员信息 | ✅ |
| GET | `/member/plans` | 会员套餐列表 | ✅ |
| POST | `/member/purchase` | 购买会员 | ✅ (Mock) |
| GET | `/member/orders` | 会员购买记录 | ✅ |

#### 提醒模块
| 方法 | 路径 | 说明 | 状态 |
|------|-----|------|------|
| GET | `/reminder/list` | 提醒设置列表 | ✅ |
| POST | `/reminder` | 添加提醒 | ✅ |
| PUT | `/reminder/{id}` | 修改提醒 | ✅ |
| DELETE | `/reminder/{id}` | 删除提醒 | ✅ |

#### 地址模块
| 方法 | 路径 | 说明 | 状态 |
|------|-----|------|------|
| GET | `/address/list` | 地址列表 | ✅ |
| POST | `/address` | 添加地址 | ✅ |
| PUT | `/address/{id}` | 修改地址 | ✅ |
| DELETE | `/address/{id}` | 删除地址 | ✅ |
| PUT | `/address/{id}/default` | 设为默认 | ✅ |

#### 远程医疗模块
| 方法 | 路径 | 说明 | 状态 |
|------|-----|------|------|
| GET | `/doctor/list` | 医生列表 | ✅ (Mock) |
| GET | `/doctor/{id}` | 医生详情 | ✅ (Mock) |
| GET | `/article/list` | 科普文章列表 | ✅ (Mock) |
| GET | `/article/{id}` | 文章详情 | ✅ (Mock) |

> **在线咨询功能**：医患聊天复用私聊模块接口，以医生用户ID作为 `receiver_id` 进行消息发送与历史记录获取。

#### AI助手模块
| 方法 | 路径 | 说明 | 状态 |
|------|-----|------|------|
| POST | `/ai/chat` | AI对话 | ✅ |
| GET | `/ai/history` | 对话历史 | ✅ |
| DELETE | `/ai/history/{session_id}` | 删除对话 | ✅ |

#### 通知模块
| 方法 | 路径 | 说明 | 状态 |
|------|-----|------|------|
| GET | `/notification/list` | 通知列表 | ✅ |
| POST | `/notification/read` | 标记已读 | ✅ |
| POST | `/notification/read-all` | 全部已读 | ✅ |
| GET | `/notification/unread-count` | 未读数量 | ✅ |
| DELETE | `/notification/{id}` | 删除通知 | ✅ |

#### 轮播图模块
| 方法 | 路径 | 说明 | 状态 |
|------|-----|------|------|
| GET | `/banner/list` | 轮播图列表 | ✅ |

#### 个人统计模块
| 方法 | 路径 | 说明 | 状态 |
|------|-----|------|------|
| GET | `/stats/overview` | 数据概览 | ✅ |
| GET | `/stats/health` | 健康趋势 | ✅ |
| GET | `/stats/sport` | 运动统计 | ✅ |
| GET | `/stats/food` | 饮食统计 | ✅ |

#### 上传模块
| 方法 | 路径 | 说明 | 状态 |
|------|-----|------|------|
| POST | `/upload/image` | 上传图片 | ✅ |

#### 用户设置模块
| 方法 | 路径 | 说明 | 状态 |
|------|-----|------|------|
| GET | `/settings` | 获取用户设置 | ✅ |
| PUT | `/settings` | 更新用户设置 | ✅ |
| POST | `/settings/send-code` | 发送手机验证码 | ✅ |
| POST | `/settings/bind-phone` | 绑定手机号 | ✅ |
| POST | `/settings/unbind-phone` | 解绑手机号 | ✅ |
| POST | `/settings/delete-account` | 注销账号 | ✅ |

#### 用户反馈模块
| 方法 | 路径 | 说明 | 状态 |
|------|-----|------|------|
| POST | `/feedback` | 提交反馈 | ✅ |
| GET | `/feedback/list` | 获取我的反馈列表 | ✅ |

---

### 2.2 管理后台接口 (`/api/admin/`)

#### 管理员认证
| 方法 | 路径 | 说明 | 状态 |
|------|-----|------|------|
| POST | `/auth/login` | 管理员登录 | ✅ |
| POST | `/auth/logout` | 退出登录 | ✅ |
| GET | `/auth/info` | 获取管理员信息 | ✅ |

#### 用户管理
| 方法 | 路径 | 说明 | 状态 |
|------|-----|------|------|
| GET | `/user/list` | 用户列表 | ✅ |
| GET | `/user/{id}` | 用户详情 | ✅ |
| PUT | `/user/{id}/status` | 禁用/启用用户 | ✅ |

#### 内容审核
| 方法 | 路径 | 说明 | 状态 |
|------|-----|------|------|
| GET | `/audit/posts` | 待审核动态列表 | ✅ |
| PUT | `/audit/post/{id}` | 审核动态 | ✅ |
| GET | `/audit/comments` | 待审核评论列表 | ✅ |
| PUT | `/audit/comment/{id}` | 审核评论 | ✅ |

#### 商品管理
| 方法 | 路径 | 说明 | 状态 |
|------|-----|------|------|
| GET | `/product/list` | 商品列表 | ✅ |
| POST | `/product` | 添加商品 | ✅ |
| PUT | `/product/{id}` | 编辑商品 | ✅ |
| DELETE | `/product/{id}` | 删除商品 | ✅ |
| GET | `/category/list` | 分类列表 | ✅ |
| POST | `/category` | 添加分类 | ✅ |
| PUT | `/category/{id}` | 编辑分类 | ✅ |
| DELETE | `/category/{id}` | 删除分类 | ✅ |

#### 订单管理
| 方法 | 路径 | 说明 | 状态 |
|------|-----|------|------|
| GET | `/order/list` | 订单列表 | ✅ |
| GET | `/order/{id}` | 订单详情 | ✅ |
| POST | `/order/{id}/ship` | 发货 | ✅ |
| POST | `/order/{id}/refund` | 退款处理 | ✅ |

#### 数据统计
| 方法 | 路径 | 说明 | 状态 |
|------|-----|------|------|
| GET | `/stats/overview` | 数据概览 | ✅ |
| GET | `/stats/user` | 用户统计 | ✅ |
| GET | `/stats/order` | 订单统计 | ✅ |
| GET | `/stats/health` | 健康数据统计 | ✅ |

#### 反馈管理
| 方法 | 路径 | 说明 | 状态 |
|------|-----|------|------|
| GET | `/feedback/list` | 反馈列表（分页） | ✅ |
| GET | `/feedback/{id}` | 反馈详情 | ✅ |
| PUT | `/feedback/{id}` | 更新反馈状态 | ✅ |
| POST | `/feedback/{id}/reply` | 回复反馈 | ✅ |
| DELETE | `/feedback/{id}` | 删除反馈 | ✅ |

#### 系统设置
| 方法 | 路径 | 说明 | 状态 |
|------|-----|------|------|
| GET | `/setting/points` | 积分规则配置 | ✅ |
| PUT | `/setting/points` | 更新积分规则 | ✅ |
| GET | `/setting/member` | 会员配置 | ✅ |
| PUT | `/setting/member` | 更新会员配置 | ✅ |
| GET | `/setting/system` | 系统配置列表 | ✅ |
| PUT | `/setting/system` | 更新系统配置 | ✅ |

---

## 3. 暂缓实现的功能

以下功能根据 `00-开发约束与说明.md` 暂缓实现：

| 功能 | 原因 | 当前处理 |
|------|------|----------|
| GPS运动轨迹 | 后端逻辑复杂 | 前端mock，后端预留接口 |
| 微信/支付宝支付 | 需要商户号 | 返回模拟支付成功 |
| AI图像识别 | 需要模型集成 | 预留接口结构 |
| 硬件数据接入 | 无设备 | 用手动输入代替 |
| 面部/饮食识别 | 复杂AI | 预留接口返回mock |

---

## 4. 启动方式

### 4.1 开发环境

```bash
cd backend

# 创建虚拟环境
python -m venv venv

# 激活虚拟环境 (Windows)
.\venv\Scripts\activate

# 安装依赖
pip install -r requirements.txt

# 配置环境变量
cp .env.example .env
# 编辑 .env 填入数据库等配置

# 启动服务
python run.py
# 或
uvicorn app.main:app --reload --host 0.0.0.0 --port 8000
```

### 4.2 API 文档

启动后访问：
- Swagger UI: http://localhost:8000/docs
- ReDoc: http://localhost:8000/redoc

---

## 5. 测试数据

数据库已注入完整测试数据，覆盖所有模块：

| 模块 | 数据量 |
|------|--------|
| 用户 | 10+ |
| 健康筛查记录 | 20+ |
| 运动记录 | 50+ |
| 饮食记录 | 50+ |
| 商品 | 10+ |
| 订单 | 10+ |
| 社区动态 | 20+ |
| 评论 | 30+ |
| 其他... | 若干 |

### 测试账号

**小程序端**：通过微信登录，无需账号

**管理后台**：
- 用户名: `admin`
- 密码: `admin123`

---

## 6. 注意事项

1. **数据库连接**：确保 MySQL 服务已启动，配置正确
2. **JWT Token**：小程序请求需带 `Authorization: Bearer {token}` 头
3. **文件上传**：上传的文件存储在 `uploads/` 目录
4. **CORS**：已配置允许所有来源，生产环境需限制
5. **AI服务**：需配置阿里云百炼 API Key 才能使用 AI 功能

---

## 7. 新增接口说明

### 7.1 用户公开信息接口

**位置**：`app/api/v1/user.py`

**接口**：`GET /user/{user_id}/profile`

**功能**：获取其他用户的公开信息，用于社区他人主页展示

**请求参数**：
- `user_id` (路径参数): 用户ID

**响应示例**：
```json
{
  "code": 200,
  "message": "success",
  "data": {
    "id": 1,
    "nickname": "用户昵称",
    "avatar": "/uploads/avatars/xxx.jpg",
    "bio": null,
    "gender": 1,
    "user_level": 3,
    "follower_count": 100,
    "following_count": 50,
    "like_count": 500,
    "is_followed": false
  }
}
```

**实现要点**：
- 统计用户获赞数（所有动态的点赞总和）
- 检查当前登录用户是否已关注该用户
- 支持未登录访问（`is_followed` 为 `false`）

### 7.2 运动记录接口

**位置**：`app/api/v1/sport.py`

**接口**：
| 方法 | 路径 | 说明 |
|------|-----|------|
| POST | `/sport/record` | 提交运动记录 |
| GET | `/sport/records` | 运动记录列表 |
| POST | `/sport/checkin` | 运动打卡 |

**运动记录字段**：
- `sport_type`: 运动类型 (outdoor_run/treadmill/walk/cycling等)
- `sport_name`: 运动名称
- `duration`: 时长(分钟)
- `distance`: 距离(米)
- `calories`: 消耗卡路里
- `coins_earned`: 获得运动币

**运动币计算规则**：
- 每10分钟运动获得1个运动币
- 单次最多获得50个运动币

### 7.3 饮食记录接口

**位置**：`app/api/v1/food.py`

**接口**：
| 方法 | 路径 | 说明 |
|------|-----|------|
| POST | `/food/record` | 提交饮食记录 |
| GET | `/food/records` | 饮食记录列表 |
| GET | `/food-library/search` | 搜索食物库 |

**饮食记录字段**：
- `meal_type`: 餐次 (breakfast/lunch/dinner/snack)
- `record_date`: 记录日期
- `food_name`: 食物名称
- `amount`: 份量(克)
- `calories`: 卡路里
- `protein/carbs/fat/fiber`: 营养成分

### 7.4 购物车接口数据结构

**位置**：`app/api/v1/cart.py`

**返回数据结构**：
```json
{
  "code": 200,
  "data": {
    "list": [
      {
        "id": 1,
        "product_id": 10,
        "quantity": 2,
        "is_selected": 1,
        "product": {
          "name": "商品名称",
          "image": "/uploads/xxx.jpg",
          "price": 99.00,
          "original_price": 129.00,
          "stock": 100,
          "is_on_sale": 1
        },
        "subtotal": 198.00,
        "is_valid": true
      }
    ],
    "total_amount": 198.00,
    "selected_amount": 198.00,
    "total_count": 1
  }
}
```

**注意**：前端需使用 `res.data.list` 获取列表，商品信息在 `product.image` 和 `product.price` 字段

### 7.5 用户设置接口

**位置**：`app/api/v1/settings.py`

**数据库表**：`user_settings`、`user_feedbacks`

**接口列表**：
| 方法 | 路径 | 说明 |
|------|-----|------|
| GET | `/settings` | 获取用户设置 |
| PUT | `/settings` | 更新用户设置 |
| POST | `/settings/send-code` | 发送手机验证码 |
| POST | `/settings/bind-phone` | 绑定手机号 |
| POST | `/settings/unbind-phone` | 解绑手机号 |
| POST | `/settings/delete-account` | 注销账号 |
| POST | `/feedback` | 提交反馈 |
| GET | `/feedback/list` | 获取我的反馈列表 |

**设置字段说明**：
- `share_health_data`: 向医生展示健康数据 (0否/1是)
- `public_profile`: 允许陌生人查看动态 (0否/1是)
- `personalized`: 个性化推荐 (0否/1是)
- `elderly_mode`: 长辈模式 (0否/1是)
- `notification_enabled`: 消息通知 (0否/1是)

**绑定手机号流程**：
1. 调用 `POST /settings/send-code?phone=xxx` 发送验证码
2. 验证码有效期 5 分钟
3. 调用 `POST /settings/bind-phone` 提交手机号和验证码完成绑定

**账号注销**：
- 调用 `POST /settings/delete-account` 后，用户状态设为禁用
- 用户昵称改为"已注销用户{id}"
- 头像、手机号等敏感信息清空

