# 十二、多 AI 协作开发规范

> 本项目使用多个 AI 助手协作开发，需遵守本规范确保代码一致性。

---

## 1. AI 分工

| AI 助手 | 负责模块 | 主要职责 |
|--------|---------|---------|
| **Gemini** | 小程序前端 (uni-app) | 页面开发、组件编写、样式、用户交互 |
| **Claude Opus** | 后端 (FastAPI) + 数据库 | API 接口、业务逻辑、数据库操作 |
| **Claude Opus** | Web 管理端 (Vue 3) | 管理后台页面（可选） |

---

## 2. 协作原则

### 2.1 接口优先（Contract First）

**接口规范是协作的核心**：

1. 后端先定义接口 → 写入 `docs/09-API接口规范.md`
2. 前端按接口规范开发 → 读取同一文档
3. 任何接口变更 → 必须同步更新文档

```
[后端 Claude]                    [前端 Gemini]
     │                                │
     │  1. 定义/修改接口               │
     ▼                                │
┌─────────────────────────────────────┴───┐
│         docs/09-API接口规范.md          │
│         (单一真理之源)                   │
└─────────────────────────────────────┬───┘
                                      │
                                      │  2. 读取接口规范
                                      ▼
                                 [前端开发]
```

### 2.2 文档即规范

| 文档 | 前端需遵守 | 后端需遵守 |
|-----|-----------|-----------|
| `00-开发约束与说明.md` | ✅ | ✅ |
| `04-功能模块设计.md` | ✅ | ✅ |
| `06-界面设计规范.md` | ✅ | - |
| `08-技术栈与架构.md` | ✅（前端部分） | ✅（后端部分） |
| `09-API接口规范.md` | ✅ **必须** | ✅ **必须** |
| `数据库设计/` | - | ✅ |

### 2.3 数据格式统一

**请求格式**：
```json
{
  "field_name": "value"  // 使用 snake_case
}
```

**响应格式**：
```json
{
  "code": 200,
  "message": "success",
  "data": { ... }
}
```

**时间格式**：
```
ISO 8601: "2025-11-27T10:30:00Z"
```

**分页格式**：
```json
{
  "code": 200,
  "data": {
    "list": [...],
    "total": 100,
    "page": 1,
    "page_size": 20
  }
}
```

---

## 3. 前端开发规范（Gemini 专用）

### 3.1 开发前必读

1. `docs/00-开发约束与说明.md` - 禁用 Emoji、占位图规范
2. `docs/06-界面设计规范.md` - UI 设计规范
3. `docs/08-技术栈与架构.md` - 组件库用法（Wot Design Uni）
4. `docs/09-API接口规范.md` - 接口地址和参数
5. `.cursorrules` - 项目开发规则

### 3.2 技术约束

- **框架**：uni-app + Vue 3 + TypeScript
- **组件库**：Wot Design Uni（优先）
- **状态管理**：Pinia
- **样式**：SCSS + CSS 变量
- **禁止**：使用 Emoji、硬编码颜色值

### 3.3 接口调用规范

```typescript
// 正确：使用封装的请求方法
import { request } from '@/utils/request'

const res = await request.get('/user/profile')

// 错误：直接使用 uni.request
uni.request({ url: '...' })  // ❌
```

### 3.4 Mock 数据规范

后端接口未完成时，使用 Mock 数据：

```typescript
// api/user.ts
export async function getUserProfile() {
  // TODO: 对接后端接口
  // 当前: 返回 Mock 数据
  return {
    code: 200,
    data: {
      id: 1,
      nickname: '测试用户',
      avatar: '/static/placeholder/avatar.png'
    }
  }
}
```

---

## 4. 后端开发规范（Claude Opus 专用）

### 4.1 开发前必读

1. `docs/00-开发约束与说明.md` - 暂缓功能清单
2. `docs/04-功能模块设计.md` - 业务逻辑
3. `docs/08-技术栈与架构.md` - 代码风格
4. `docs/09-API接口规范.md` - 接口定义
5. `docs/数据库设计/` - 表结构
6. `.cursorrules` - 项目开发规则

### 4.2 技术约束

- **框架**：Python 3.10+ + FastAPI
- **ORM**：SQLAlchemy 2.0（异步）
- **数据库**：MySQL 8.0（health_db）
- **路由前缀**：`/api/v1/`

### 4.3 接口开发流程

1. **先更新文档**：在 `09-API接口规范.md` 添加接口定义
2. **再写代码**：按文档实现接口
3. **返回统一格式**：

```python
from fastapi import APIRouter

router = APIRouter(prefix="/user", tags=["用户"])

@router.get("/profile")
async def get_profile(current_user = Depends(get_current_user)):
    """
    获取用户信息
    
    对应文档: docs/09-API接口规范.md - 用户模块 - GET /user/profile
    """
    return {
        "code": 200,
        "message": "success",
        "data": {
            "id": current_user.id,
            "nickname": current_user.nickname
        }
    }
```

### 4.4 暂缓功能处理

```python
@router.post("/order/{order_id}/pay")
async def create_payment(order_id: int):
    """
    发起支付
    
    TODO: 暂缓实现
    原因: 需要微信商户资质
    当前: 返回模拟成功
    """
    return {
        "code": 200,
        "message": "模拟支付成功",
        "data": {"order_id": order_id, "status": "paid"}
    }
```

---

## 5. 协作沟通规范

### 5.1 接口变更通知

当后端需要变更接口时：

1. 先更新 `docs/09-API接口规范.md`
2. 在变更处添加注释：

```markdown
| GET | `/user/profile` | 获取个人信息 |
| GET | `/user/stats` | 获取用户统计 | <!-- 新增于 2025-11-27 -->
```

### 5.2 问题记录

遇到需要另一方配合的问题，记录在：

```
docs/协作问题记录.md（如需要可创建）
```

格式：
```markdown
## 2025-11-27

### [前端] 需要后端支持
- [ ] `/user/profile` 接口缺少 `avatar` 字段

### [后端] 需要前端确认
- [ ] 分页参数使用 `page` 还是 `offset`？
```

---

## 6. 开发顺序（前端优先）

本项目采用**前端优先**策略：先完成前端所有页面，再开发后端。

```
阶段1: 前端开发（Gemini）
├── 搭建 uni-app 项目框架
├── 开发所有页面和组件
├── 使用 Mock 数据模拟接口
├── 完成 UI 交互和样式
└── 产出: 完整的前端代码 + 明确的接口需求

阶段2: 后端开发（Claude Opus）
├── 搭建 FastAPI 项目框架
├── 根据前端需求实现所有接口
├── 数据库操作和业务逻辑
└── 产出: 完整的后端 API

阶段3: 前后端联调
├── 前端切换到真实接口
├── 修复联调问题
└── 完成测试
```

### 前端 Mock 数据规范

前端开发时，所有接口使用 Mock 数据：

```typescript
// api/user.ts
export async function getUserProfile() {
  // TODO: 后端完成后替换为真实接口
  // return request.get('/user/profile')
  
  // Mock 数据
  return {
    code: 200,
    message: 'success',
    data: {
      id: 1,
      nickname: '测试用户',
      avatar: '/static/placeholder/avatar.png',
      sport_coins: 100,
      food_coins: 50
    }
  }
}
```

### Mock 数据文件结构

```
src/
├── api/
│   ├── user.ts      # 用户接口（含Mock）
│   ├── health.ts    # 健康筛查接口（含Mock）
│   ├── sport.ts     # 运动接口（含Mock）
│   ├── food.ts      # 饮食接口（含Mock）
│   ├── shop.ts      # 商城接口（含Mock）
│   ├── community.ts # 社区接口（含Mock）
│   └── mock/        # Mock 数据集中管理（可选）
│       ├── user.ts
│       ├── products.ts
│       └── posts.ts
```

### 切换到真实接口

后端完成后，只需修改 api 文件：

```typescript
// api/user.ts - 切换前
export async function getUserProfile() {
  // Mock
  return { code: 200, data: { ... } }
}

// api/user.ts - 切换后
export async function getUserProfile() {
  return request.get('/user/profile')
}
```

---

## 7. 调试与联调

### 7.1 后端 API 测试

```bash
# 启动后端
cd backend
uvicorn app.main:app --reload --port 8000

# API 文档
http://localhost:8000/docs
```

### 7.2 前端连接后端

```typescript
// utils/request.ts
const BASE_URL = 'http://localhost:8000/api/v1'
```

### 7.3 跨域配置（后端）

```python
# main.py
from fastapi.middleware.cors import CORSMiddleware

app.add_middleware(
    CORSMiddleware,
    allow_origins=["*"],  # 开发环境允许所有
    allow_methods=["*"],
    allow_headers=["*"],
)
```

